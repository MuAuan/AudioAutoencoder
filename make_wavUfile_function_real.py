#https://www.nicovideo.jp/watch/sm13283644 niconico ここの周波数を使いました
#https://qiita.com/rild/items/339c5c36f4c1ad8d4325 qiita ここの周波数を使いました

import numpy as np
from matplotlib import pyplot as plt
import wave
import struct
import pyaudio
from scipy.fftpack import fft, ifft
import cv2

#パラメータ
RATE=44100
N=1
CHUNK=1024*N
p=pyaudio.PyAudio()
fn=RATE
nperseg=fn*N

stream=p.open(format = pyaudio.paInt16,
        channels = 1,
        rate = RATE,
        frames_per_buffer = CHUNK,
        input = True,
        output = True) # inputとoutputを同時にTrueにする

fs = RATE#サンプリング周波数
sec = 0.1 #秒
s='aiueo_'
sa='a'
def sin_wav(A,f0,fs,t):
    point = np.arange(0,fs*t)
    sin_wav =A* np.sin(2*np.pi*f0*point/fs)
    return sin_wav

def create_wave(A,f0,fs,t):#A:振幅,f0:基本周波数,fs:サンプリング周波数,再生時間[s]
    sin_wave=0
    print(A[0])
    int_f0=int(f0[0])
    for i in range(0,len(A),1):
        f1=f0[i]
        sw=sin_wav(A[i],f1,fs,t)
        sin_wave += sw
    sin_wave = [int(x * 32767.0) for x in sin_wave]    
    binwave = struct.pack("h" * len(sin_wave), *sin_wave)
    w = wave.Wave_write('./aiueo/'+s+'/'+sa+'/'+str(int_f0)+'Hz.wav')
    p = (1, 2, fs, len(binwave), 'NONE', 'not compressed')
    w.setparams(p)
    w.writeframes(binwave)
    w.close()

def sound_wave(fu):
    int_f0=int(fu)
    wavfile = './aiueo/'+s+'/'+sa+'/'+str(int_f0)+'Hz.wav'
    wr = wave.open(wavfile, "rb")
    input = wr.readframes(wr.getnframes())
    output = stream.write(input)
    sig =[]
    sig = np.frombuffer(input, dtype="int16")  /32768.0
    return sig

fig = plt.figure(figsize=(12, 8)) #...1
ax1 = fig.add_subplot(211)
ax2 = fig.add_subplot(212)
f0=124.892578125 #261.626
#f=(124.892578125, 249.78515625, 374.677734375, 499.5703125, 633.076171875, 2015.5078125, 2084.4140625, 2144.70703125, 2269.599609375, 2519.384765625, 2648.583984375)
af=5
A=(af*0.03294071031794345, af*0.02194857429065602, af*0.03385318455479758, af*0.015415433874235319, af*0.0020821547384600133, af*0.003950839405450386, af*0.002879261968524165, af*0.0033481103761516893, af*0.0032442301217720185, af*0.003144335174842186, af*0.0020677289986332377)
f=(f0,2*f0,3*f0,4*f0,5.07*f0,16.13*f0,16.69*f0,17.17*f0,18.17*f0,20.17*f0,21.21*f0) #a

def B(a0=220):
    B=[]
    r= 1.059463094
    b=1
    for n in range(60):
        b *= r
        B.append(b*a0)
    return B

B=B(f0)
sk=0

def skf(sk):
    skf=sk
    skf = skf+1
    skf=skf%60
    print(skf)
    f0=B[skf]
    return f0,skf

while True:
    create_wave(A, f, fs, sec)
    sig = sound_wave(f[0])
    #cv2.imshow('image',img)
    freq =fft(sig,int(fn))
    Pyy = np.sqrt(freq*freq.conj())/fn
    f = np.arange(0,RATE,RATE/fn)
    ax2.set_ylim(0,0.05)
    ax2.set_xlim(20,20000)
    ax2.set_xlabel('Freq[Hz]')
    ax2.set_ylabel('Power')
    ax2.set_xscale('log')
    ax2.plot(f,Pyy)
    
    #ax2.set_axis_off()
    x = np.linspace(0, 1, sec*nperseg)
    ax1.plot(x,sig)
    ax1.set_ylim(-1,1)
    int_f0=int(f0)
    plt.savefig('./aiueo/'+s+'/'+sa+'/IntensityvsFreq_'+str(int_f0)+'.jpg')
    plt.clf()
    ax1 = fig.add_subplot(211)
    ax2 = fig.add_subplot(212)
    img=cv2.imread('./aiueo/'+s+'/'+sa+'/IntensityvsFreq_'+str(int_f0)+'.jpg')
    cv2.imshow('image',img)
    print("f0_{},A_{},B_{},C_{}".format(int_f0,int(A[0]),int(A[1]),int(A[2])))
    k = cv2.waitKey(0)
    if k == 27:         # wait for ESC key to exit
        cv2.destroyAllWindows()
        break
    elif k == ord('e'): # e 
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,int(A[0]),int(A[1]),int(A[2])),img)
        sa='e'
        #f0,sk=skf(sk)
        f=(124.892578125, 249.78515625, 374.677734375, 499.5703125, 633.076171875, 2015.5078125, 2084.4140625, 2144.70703125, 2269.599609375, 2519.384765625, 2648.583984375)
        af=5
        A=(af*0.03294071031794345, af*0.02194857429065602, af*0.03385318455479758, af*0.015415433874235319, af*0.0020821547384600133, af*0.003950839405450386, af*0.002879261968524165, af*0.0033481103761516893, af*0.0032442301217720185, af*0.003144335174842186, af*0.0020677289986332377)
        #A=(0.19,0.09,0.08,0.07,0.08) #qiita
        #A=(0.18,0.14,0.13,0.03,0.03) #niconico
    elif k == ord('c'):
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='e'
        f0,sk=skf(sk)
        #f=(124.892578125, 249.78515625, 374.677734375, 499.5703125, 633.076171875, 2015.5078125, 2084.4140625, 2144.70703125, 2269.599609375, 2519.384765625, 2648.583984375)
        f=(f0,2*f0,3*f0,4*f0,5.07*f0,16.13*f0,16.69*f0,17.17*f0,18.17*f0,20.17*f0,21.21*f0)
        af=5
        A=(af*0.03294071031794345, af*0.02194857429065602, af*0.03385318455479758, af*0.015415433874235319, af*0.0020821547384600133, af*0.003950839405450386, af*0.002879261968524165, af*0.0033481103761516893, af*0.0032442301217720185, af*0.003144335174842186, af*0.0020677289986332377)
        #f=(f0,2*f0,3*f0,4*f0,11*f0)
        #A=(0.19,0.09,0.08,0.07,0.08) #qiita
        #A=(0.18,0.14,0.13,0.03,0.03) #niconico
    elif k == ord('a'): # a 
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='a'
        #f0,sk=skf(sk)
        f=(120.5859375, 245.478515625, 366.064453125, 490.95703125, 611.54296875, 736.435546875, 857.021484375, 981.9140625, 1102.5, 1227.392578125, 1347.978515625, 2575.37109375) #a
        #f0=147.3 #261.626
        af=7
        A=(af*0.020341390534574125, af*0.0174566788127074, af*0.010131347526395808, af*0.009747680102673519, af*0.015166728085684776, af*0.03008944156794835, af*0.01425681290192185, af*0.011114100926452451, af*0.01230415315839016, af*0.008722281929922268, af*0.002063445551646237, af*0.0025587383329920307)
        #f=(f0,2*f0,3*f0,4*f0,5*f0,6*f0)
        #A=(0.07,0.09,0.08,0.19,0.08,0.07) #qiita
        #A=(0.07,0.09,0.08,0.19,0.08,0.07) #niconico
    elif k == ord('z'):
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='a'
        f0,sk=skf(sk)
        f=(120.5859375, 245.478515625, 366.064453125, 490.95703125, 611.54296875, 736.435546875, 857.021484375, 981.9140625, 1102.5, 1227.392578125, 1347.978515625, 2575.37109375) #a
        #f0=147.3 #261.626
        af=7
        A=(af*0.020341390534574125, af*0.0174566788127074, af*0.010131347526395808, af*0.009747680102673519, af*0.015166728085684776, af*0.03008944156794835, af*0.01425681290192185, af*0.011114100926452451, af*0.01230415315839016, af*0.008722281929922268, af*0.002063445551646237, af*0.0025587383329920307)
        #f=(f0,2*f0,3*f0,4*f0,5*f0,6*f0) 
        #=(0.07,0.09,0.08,0.19,0.08,0.07)  #qiita
        #A=(0.07,0.09,0.08,0.19,0.08,0.07) #niconico
    elif k == ord('i'): # i
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='i'
        #f0,sk=skf(sk)
        af=10
        f=(133.505859375, 267.01171875, 404.82421875, 538.330078125, 2553.837890625, 2825.15625, 2958.662109375, 3092.16796875, 3359.1796875, 3492.685546875)
        A=(af*0.03664427419663971, af*0.04814245343332287, af*0.004812890955338644, af*0.004670315357349598, af*0.0050331903042503895, af*0.0022537047074424597, af*0.0020052624724400557, af*0.0023413896684897836, af*0.0030016619998146812, af*0.0025613801959698222)
        #f=(f0,2*f0,11*f0,12*f0,13*f0)
        #A=(0.19,0.09,0.08,0.07,0.08)  #qiita
        #A=(0.52,0.03,0.02,0.01,0.02) #niconico
    elif k == ord('p'):
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='i'
        #f0,sk=skf(sk)
        af=10
        f=(133.505859375, 267.01171875, 404.82421875, 538.330078125, 2553.837890625, 2825.15625, 2958.662109375, 3092.16796875, 3359.1796875, 3492.685546875)
        A=(af*0.03664427419663971, af*0.04814245343332287, af*0.004812890955338644, af*0.004670315357349598, af*0.0050331903042503895, af*0.0022537047074424597, af*0.0020052624724400557, af*0.0023413896684897836, af*0.0030016619998146812, af*0.0025613801959698222)
        #f=(f0,2*f0,11*f0,12*f0,13*f0)
        #A=(0.19,0.09,0.08,0.07,0.08) #qiita
        #A=(0.52,0.03,0.02,0.01,0.02) #niconico
    elif k == ord('o'): # o
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='o'
        #f0,sk=skf(sk)
        f=(124.892578125, 254.091796875, 378.984375, 503.876953125, 633.076171875, 757.96875)
        af=5
        A=(af*0.01115226159372133, af*0.010801688165345033, af*0.03377546505498026, af*0.0161739792142228, af*0.0050367312819833985, af*0.005931045730431943)
        #f=(f0,2*f0,3*f0,4*f0)
        #A=(0.11,0.12,0.12,0.19)  #qiita
        #A=(0.11,0.14,0.10,0.24) #niconico
    elif k == ord('r'):
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='o'
        #f0,sk=skf(sk)
        f=(124.892578125, 254.091796875, 378.984375, 503.876953125, 633.076171875, 757.96875)
        af=5
        A=(af*0.01115226159372133, af*0.010801688165345033, af*0.03377546505498026, af*0.0161739792142228, af*0.0050367312819833985, af*0.005931045730431943)
        #f=(f0,2*f0,3*f0,4*f0)
        #A=(0.11,0.12,0.12,0.19)  #qiita
        #A=(0.11,0.14,0.10,0.24) #niconico
    elif k == ord('u'): # u
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='u'
        #f0,sk=skf(sk)
        f=(133.505859375, 267.01171875, 400.517578125, 534.0234375, 801.03515625, 1072.353515625, 1197.24609375)
        af=5
        A=(af*0.042994726754283924, af*0.06852360345545412, af*0.018015345032355225, af*0.00607967896156388, af*0.0014493636846237001, af*0.0014707693223757017, af*0.0014606267982074307)
        #f=(f0,2*f0,4*f0,5*f0,6*f0)
        #A=(0.19,0.08,0.08,0.08,0.09) #qiita
        #A=(0.32,0.11,0.02,0.02,0.13) #niconico
    elif k == ord('t'):
        cv2.imwrite('./aiueo/'+s+'/'+sa+'/f0_{}_{}_{}_{}.jpg'.format(int_f0,A[0],A[1],A[2]),img)
        sa='u'
        #f0,sk=skf(sk)
        f=(133.505859375, 267.01171875, 400.517578125, 534.0234375, 801.03515625, 1072.353515625, 1197.24609375)
        af=5
        A=(af*0.042994726754283924, af*0.06852360345545412, af*0.018015345032355225, af*0.00607967896156388, af*0.0014493636846237001, af*0.0014707693223757017, af*0.0014606267982074307)
        #f=(f0,2*f0,4*f0,5*f0,6*f0)
        #A=(0.19,0.08,0.08,0.08,0.09) #qiita
        #A=(0.32,0.11,0.02,0.02,0.13) #niconico